# 장바구니 분석 (Market Basket Analysis)

## 1. 분석 개요

### 1.1 장바구니 분석의 필요성

**장바구니 분석(MBA, Market Basket Analysis)**은  
고객이 하나의 주문에서 함께 구매한 상품 패턴을 분석하여  
상품 간 연관 규칙을 찾는 분석 기법이다.

#### 비즈니스 활용 목적

- **상품 번들링 전략**: 자주 함께 구매되는 상품을 묶어서 판매
- **교차 판매(Cross-sell)**: A 상품 구매 고객에게 B 상품 추천
- **매장 진열 최적화**: 연관 상품을 가까이 배치하여 구매 유도
- **프로모션 기획**: “A+B 함께 구매 시 할인”과 같은 마케팅 전략
- **재고 관리**: 연관 상품의 재고를 함께 고려하여 운영

#### 실제 사례

- “맥주와 기저귀” 사례: 월마트의 대표적인 장바구니 분석 사례
- “이 상품을 구매한 고객은 이런 상품도 구매했습니다”  
  → 아마존 추천 시스템의 핵심 아이디어

---

### 1.2 이커머스 프로젝트에서의 장바구니 분석 정의

#### 데이터셋

- **Online Retail Dataset**
  - 영국 기반 이커머스 거래 데이터
  - 약 50만 건의 거래 데이터 포함

#### 분석 도구 및 접근 방식

- **데이터 저장**
  - PostgreSQL: 원본 데이터 적재 및 관리

- **분석 및 시각화**
  - Python (pandas, mlxtend, matplotlib 등)
    - 데이터 규모가 약 50만 행으로 메모리 내 처리 가능
    - Apriori 알고리즘 등 복잡한 계산은 Python 라이브러리가 효율적
    - 전처리 → 분석 → 시각화까지 하나의 환경에서 진행 가능

> 참고:  
> 수백만 행 이상의 대용량 데이터의 경우  
> SQL로 전처리 후 Python으로 분석하는 하이브리드 방식을 사용하지만,  
> 본 프로젝트는 데이터 규모가 비교적 작아 Python 중심으로 분석을 수행하였다.

#### 분석 단위 정의

- **장바구니 = 하나의 Invoice (InvoiceNo)**
- 동일한 InvoiceNo에 포함된 상품 목록을 하나의 거래(Transaction)로 정의

#### 분석 목표

1. 자주 함께 구매되는 상품 조합 탐색
2. 상품 A를 구매한 고객이 상품 B를 구매할 확률 계산
3. 의미 있는 연관 규칙(Association Rules) 도출

#### 주요 지표

- **Support (지지도)**  
  전체 거래 중 특정 상품 조합이 등장하는 비율

- **Confidence (신뢰도)**  
  상품 A를 구매했을 때 상품 B를 구매할 확률

- **Lift (향상도)**  
  두 상품이 우연이 아닌 연관 관계를 가지는지 나타내는 지표  
  (Lift > 1 이면 양의 상관관계)

---

## 2. 분석 프로세스

### 전체 분석 흐름

1. 라이브러리 설치 및 불러오기
2. 데이터 로드 및 전처리
3. 트랜잭션 데이터 형식으로 변환
4. Apriori 알고리즘으로 빈발 항목 집합 도출
5. 연관 규칙 생성 및 필터링
6. 결과 해석 및 시각화
7. 비즈니스 인사이트 도출

### 주요 라이브러리

- **mlxtend**
  - 장바구니 분석 전용 라이브러리
  - Apriori 알고리즘 및 연관 규칙 생성 기능 제공

- **TransactionEncoder**
  - 트랜잭션 데이터를 One-Hot Encoding 형태로 변환

- **Apriori 알고리즘**
  - 자주 함께 구매되는 상품 조합을 탐색하는 알고리즘
  - `min_support` 값 설정이 중요

#### min_support 설정 기준

- 너무 낮은 경우 (예: 0.001 = 0.1%)
  - 규칙이 과도하게 많아져 해석이 어려움
- 너무 높은 경우 (예: 0.05 = 5%)
  - 의미 있는 상품 조합을 놓칠 수 있음
- **본 프로젝트에서는 0.01 ~ 0.02 (1~2%)를 기준으로 설정**


### min_support 튜닝 과정

- 초기 min_support를 0.01(1%)로 설정하여 분석을 시도함
- 빈발 항목 수가 급격히 증가하며 Apriori 연산 시간이 길어지는 문제 발생
- 분석 효율성과 해석 가능성을 고려하여 min_support를 0.02(2%)로 상향 조정
- 그 결과:
  - 연산 속도 개선
  - 과도한 노이즈 규칙 제거
  - 비즈니스적으로 의미 있는 규칙 중심 분석 가능
---

### 연관 규칙 생성

- 빈발 항목 집합(Frequent Itemsets)을 기반으로 연관 규칙 생성
- 기준 지표(metric): **Lift**
- `min_threshold = 1.0`  
  → Lift가 1보다 큰 규칙만 선택하여 양의 상관관계만 분석

#### 연관 규칙 주요 컬럼

- `antecedents`: 선행 상품 (A)
- `consequents`: 후행 상품 (B)
- `support`: A와 B를 함께 구매한 거래 비율
- `confidence`: A를 구매했을 때 B를 구매할 확률
- `lift`: A와 B의 연관성 강도

#### 필터링 조건

- **Lift > 2**: 연관성이 강한 규칙
- **Confidence > 0.3**: 신뢰도 30% 이상
- **Support > 0.01**: 전체 거래의 최소 1% 이상에서 발생

---

## 3. 시각화 결과

### 산출물

- `mba_scatter_plots.png`  
  - Support / Confidence / Lift 간 관계를 나타낸 산점도

- `top10_rules_lift.png`  
  - Lift 기준 상위 10개 연관 규칙 시각화

- `mba_network.png`  
  - 상위 15개 연관 규칙을 네트워크 그래프로 표현

---

## 4. 비즈니스 활용 예시

### 예시 규칙

**REGENCY CAKESTAND 3 TIER → PINK REGENCY TEACUP AND SAUCER**

- Lift: 5.2
- Confidence: 65%
- Support: 2.3%

#### 해석

- 케이크 스탠드를 구매한 고객은  
  일반 고객 대비 **5.2배** 더 높은 확률로 핑크 티컵을 구매
- 케이크 스탠드 구매 고객의 **65%**가 티컵을 함께 구매
- 전체 거래의 **2.3%**에서 해당 조합이 발생

#### 활용 방안

1. **번들 상품 구성**  
   - “티타임 세트 (케이크 스탠드 + 티컵)” 기획
2. **교차 판매 전략**  
   - 케이크 스탠드 상품 페이지에 티컵 추천
3. **프로모션 기획**  
   - “케이크 스탠드 구매 시 티컵 20% 할인”
4. **매장 진열 최적화**  
   - 두 상품을 인접하게 배치하여 추가 구매 유도

